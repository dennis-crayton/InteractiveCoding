<h1 class="page-title">Create Interactive Language Tutorial</h1>

<%= form_with model: @user_page, local: true, class: "form-container" do |form| %>
  <div class="form-group">
    <%= form.label :title, "Title" %>
    <%= form.text_field :title, class: "form-control", required: true %>
  </div>

  <!-- ðŸ”¹ Dynamic Language Selection -->
  <div class="form-group language-selection">
    <%= form.label :language, "Language" %>
    <select id="languageSelect" name="user_page[language]" class="form-control" required>
      <option value="" disabled selected>Select a language</option>
      <option value="ruby" data-image="ruby:3.3-alpine" data-ext=".rb" data-command="ruby">Ruby</option>
      <option value="python" data-image="python:3.12-alpine" data-ext=".py" data-command="python3">Python</option>
      <option value="java" data-image="openjdk:17-alpine" data-ext=".java" data-command="javac">Java</option>
      <option value="custom">Custom</option>
    </select>

    <div id="customLanguageFields" style="display:none; margin-top:10px;">
      <label>Language name:</label>
      <input type="text" name="custom_language[name]" class="form-control" placeholder="e.g. Go">

      <label>Docker image:</label>
      <input type="text" name="custom_language[image]" class="form-control" placeholder="e.g. golang:1.23-alpine">

      <label>File extension:</label>
      <input type="text" name="custom_language[extension]" class="form-control" placeholder="e.g. .go">

      <label>Command:</label>
      <input type="text" name="custom_language[command]" class="form-control" placeholder="e.g. go run">
    </div>
  </div>

  <div class="form-group">
    <%= form.label :accent_color, "Accent Color" %>
    <input type="color" id="accentColor" value="#ff0000" class="form-control">
  </div>

  <div class="form-group">
    <%= form.label :author, "Author" %>
    <%= form.text_field :author, class: "form-control" %>
  </div>

  <div class="form-group">
    <%= form.label :description, "Short Description" %>
    <%= form.text_area :description, class: "form-control", rows: 3 %>
  </div>

  <hr>

  <h2>Sections</h2>
  <div id="sections"></div>

  <div class="button-group">
    <button type="button" class="add-btn" data-type="section">+ Add Section</button>
    <button type="button" class="add-btn" data-type="code">+ Add Code Example</button>
    <button type="button" class="add-btn" data-type="exercise">+ Add Exercise</button>
  </div>

  <%= form.hidden_field :content, id: "contentField" %>

  <div class="actions">
    <%= form.submit "Save Tutorial", class: "submit-btn" %>
  </div>
<% end %>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const sections = document.getElementById("sections");
  const contentField = document.getElementById("contentField");
  const accentColorInput = document.getElementById("accentColor");
  const languageSelect = document.getElementById("languageSelect");
  const customFields = document.getElementById("customLanguageFields");

  // Show custom fields if "Custom" selected
  languageSelect.addEventListener("change", (e) => {
    customFields.style.display = e.target.value === "custom" ? "block" : "none";
    updateJSON();
  });

  const updateJSON = () => {
    const blocks = Array.from(sections.children).map(block => {
      const type = block.dataset.type;
      const inputs = block.querySelectorAll("input, textarea");
      const values = Array.from(inputs).map(el => el.value);

      // Skip empty blocks
      if (values.every(v => v.trim() === "")) return null;

      if (type === "section") {
        return { type, title: values[0], content: values[1] };
      } else if (type === "code") {
        return { type, title: values[0], code: values[1] };
      } else if (type === "exercise") {
        return { type, title: values[0], prompt: values[1], starter_code: values[2] };
      }
    }).filter(Boolean);

    let languageData = { name: languageSelect.value };
    if (languageSelect.value === "custom") {
      const customInputs = customFields.querySelectorAll("input");
      languageData = {
        name: customInputs[0].value || "Custom",
        image: customInputs[1].value || "",
        extension: customInputs[2].value || "",
        command: customInputs[3].value || ""
      };
    }

    contentField.value = JSON.stringify({
      accent_color: accentColorInput.value,
      language: languageData,
      sections: blocks
    }, null, 2);
  };

  const addBlock = (type) => {
    const div = document.createElement("div");
    div.classList.add("content-block");
    div.dataset.type = type;

    if (type === "section") {
      div.innerHTML = `
        <h3>Section</h3>
        <input type="text" placeholder="Section title" class="form-control">
        <textarea placeholder="Section content" class="form-control"></textarea>
        <button type="button" class="remove-btn">Remove</button>
      `;
    } else if (type === "code") {
      div.innerHTML = `
        <h3>Code Example</h3>
        <input type="text" placeholder="Example title" class="form-control">
        <textarea placeholder="Code..." class="form-control"></textarea>
        <button type="button" class="remove-btn">Remove</button>
      `;
    } else if (type === "exercise") {
      div.innerHTML = `
        <h3>Exercise</h3>
        <input type="text" placeholder="Exercise title" class="form-control">
        <textarea placeholder="Prompt or instructions..." class="form-control"></textarea>
        <textarea placeholder="Starter code..." class="form-control"></textarea>
        <button type="button" class="run-btn">Run Code</button>
        <pre class="output"></pre>
        <button type="button" class="remove-btn">Remove</button>
      `;
    }

    sections.appendChild(div);
    updateJSON();
  };

  document.querySelectorAll(".add-btn").forEach(button => {
    button.addEventListener("click", (e) => addBlock(e.target.dataset.type));
  });

  sections.addEventListener("input", updateJSON);
  accentColorInput.addEventListener("input", updateJSON);
  languageSelect.addEventListener("change", updateJSON);

  sections.addEventListener("click", (e) => {
    if (e.target.classList.contains("remove-btn")) {
      e.target.parentElement.remove();
      updateJSON();
    }

    if (e.target.classList.contains("run-btn")) {
      const block = e.target.closest(".content-block");
      const language = languageSelect.value;
      const code = block.querySelectorAll("textarea")[1]?.value || "";
      const output = block.querySelector(".output");
      output.textContent = "Running...";

      fetch("/code/run", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ language, code })
      })
      .then(res => res.json())
      .then(data => output.textContent = data.output)
      .catch(err => output.textContent = "Error: " + err.message);
    }
  });
});
</script>

<style>
/* Same as before; no major changes */
.page-title { font-size: 2rem; margin-bottom: 1rem; text-align: center; }
.form-container { max-width: 800px; margin: auto; }
.form-group { margin-bottom: 1rem; }
.form-control { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; }
.button-group { margin: 1rem 0; }
.add-btn { background-color: #444; color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; margin-right: 0.5rem; }
.add-btn:hover { background-color: #666; }
.remove-btn, .run-btn { background-color: #900; color: white; border: none; padding: 6px 10px; border-radius: 5px; margin-top: 8px; cursor: pointer; }
.run-btn { background-color: #2a6; }
.run-btn:hover { background-color: #3b7; }
pre.output { background: #111; color: #0f0; padding: 8px; border-radius: 6px; margin-top: 6px; font-family: monospace; }
.submit-btn { background-color: #2a6; color: white; padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; }
.submit-btn:hover { background-color: #3b7; }
.content-block { background: #f8f8f8; border: 1px solid #ddd; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
</style>
